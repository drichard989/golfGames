<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8" />
    <title>Manito Golf Games</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
    <meta name="description" content="Interactive golf scorecard with Vegas & Banker side games" />
    <!-- Aggressive cache prevention for iOS -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>â›³</text></svg>" />
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#4a9eff" />
    <link rel="stylesheet" href="stylesheet/main.css" />
    
    <!-- QR Code Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  </head>
  <body>

    <header>
      <h1>Manito Golf Games v.20 PWA</h1>
      <div class="controls">
        <div class="control" style="display: inline-block; margin-right: 12px;">
          <label for="courseSelect" style="margin-right: 4px;">Course:</label>
          <select id="courseSelect" style="padding: 8px; background: var(--panel); color: var(--ink); border: 1px solid var(--line); border-radius: 4px;">
            <!-- Options populated dynamically from COURSES in index.js -->
          </select>
        </div>
        <button id="utilitiesToggle" class="btn">âš™ï¸ Utilities</button>
        <button id="saveBtn" class="btn">ğŸ’¾ Save</button>
        <button id="refreshAllBtn" class="btn" title="Recalculate all games and totals">ğŸ”„ Recalculate Everything</button>
        <button id="themeToggle" class="theme-toggle" type="button">â˜€ï¸ Light Mode</button>
        <span class="meta" id="saveStatus" role="status" aria-live="polite"></span>
      </div>
      <div class="controls" style="margin-top: 16px; display: flex; gap: 12px; align-items: center;">
        <button id="removePlayerBtn" class="btn">âˆ’ Remove Player</button>
        <button id="addPlayerBtn" class="btn">+ Add Player</button>
        <button id="clearAllBtn" class="btn">Clear Names & Scores</button>
        <span id="playerCountDisplay" class="subtle" style="font-size: 14px;"></span>
      </div>
      <div id="utilitiesSection" class="utilities-section">
        <div class="controls">
          <div class="control">
            <label for="csvInput">CSV</label>
            <input id="csvInput" type="file" accept=".csv" />
          </div>
          <button id="dlTemplateBtn" class="btn">Download CSV Template</button>
          <button id="exportCSVBtn" class="btn">ğŸ“¤ Export Current Scorecard</button>
          <button id="emailCSVBtn" class="btn">ğŸ“§ Email Scorecard</button>
          <button id="shareHtmlBtn" class="btn">ğŸ“± Share Results</button>
          <button id="generateQRBtn" class="btn">ğŸ“· Share via QR Code</button>
          <button id="scanQRBtn" class="btn">ğŸ“¸ Scan QR Code</button>
          <div style="margin-top: 12px; padding: 12px; background: var(--panel-alt); border: 2px dashed var(--line); border-radius: 8px; text-align: center;">
            <div style="font-size: 14px; margin-bottom: 8px; color: var(--muted);">ğŸ“‹ Import QR code from image:</div>
            <input type="file" id="qrImageUpload" accept="image/*" style="display: none;" />
            <button id="uploadQRBtn" class="btn" style="width: 100%; margin-bottom: 8px;">ğŸ“ Upload QR Code Image</button>
            <div style="font-size: 12px; color: var(--muted); margin-bottom: 8px;">or paste image (Cmd/Ctrl+V):</div>
            <div id="pasteArea" style="min-height: 80px; display: flex; align-items: center; justify-content: center; background: var(--panel); border-radius: 6px; cursor: pointer; padding: 16px; border: 2px dashed var(--line);" tabindex="0">
              <span style="color: var(--muted); font-size: 13px;">Click and paste</span>
            </div>
            <div id="pasteStatus" style="margin-top: 8px; font-size: 12px; min-height: 18px;"></div>
          </div>
          <button id="resetBtn" class="btn">Reset Scores</button>
          <button id="forceRefresh" class="btn" type="button">ğŸ”„ Refresh</button>
        </div>
      </div>
      <p class="small">Swipe the table left/right. Player names stay pinned. Pars & Men's HCP are fixed from the card.</p>
      <p class="small">If a player is a + handicap, enter it as a negative number (e.g., -2).</p>
    </header>

    <p class="small" id="parBadge" aria-live="polite"></p>
    <!-- SCORECARD -->
    <div class="wrap">
      <table id="scorecard" aria-describedby="saveStatus">
          <thead>
            <tr id="holesHeader">
              <th class="align-left">Player</th>
              <th>CH</th>
              <!-- JS fills Holes 1â€“18 + Out + In + Total + To Par + Net -->
            </tr>
          </thead>
        <tbody>
          <tr class="par-row" id="parRow">
            <td class="align-left">
              <strong>Par</strong>
              <span class="subtle">(from card)</span>
            </td>
            <td></td>
          </tr>
          <tr class="hcp-row" id="hcpRow">
            <td class="align-left">
              <strong>HCP Index</strong>
              <span class="subtle">(from card)</span>
            </td>
            <td></td>
          </tr>
          <!-- Player rows inserted by JS -->
        </tbody>
        <tfoot>
          <tr id="totalsRow">
            <td class="align-left">Totals</td>
            <td></td>
            <!-- JS adds per-hole sums + Out/In/Total; placeholders align To Par / Net -->
          </tr>
        </tfoot>
      </table>
    </div>
    <!-- GAMES LAUNCHER -->
    <div class="gamesbar">
      <button id="toggleJunk" class="game-toggle">ğŸ—‘ï¸ Junk</button>
      <button id="toggleSkins" class="game-toggle">ğŸ’ Skins</button>
      <button id="toggleVegas" class="game-toggle">ğŸ² Vegas</button>
      <button id="toggleHilo" class="game-toggle">ğŸ¯ Hi-Lo</button>
      <button id="toggleBanker" class="game-toggle">ğŸ¦ Banker</button>
      <button id="toggleBankerVegas" class="game-toggle">ğŸ¦ğŸ² Banker-Vegas</button>
    </div>
    <!-- SKINS GAME -->
    <section class="game-section" id="skinsSection" aria-hidden="true">
      <h2>Skins</h2>
      <div class="banker-controls">
        <div class="control-box">
          <div class="pill">Options</div>
          <label class="radio">
            <input type="checkbox" id="skinsCarry" /> Carry over on ties </label>
          <br />
          <label class="radio">
            <input type="checkbox" id="skinsHalf" /> Half pops </label>
          <br />
          <label class="input-label">
            Buy-in per player: $<input type="number" id="skinsBuyIn" min="0" step="0.01" value="10" inputmode="decimal" autocomplete="off"
              style="width: 80px; display: inline-block; margin-left: 4px; -moz-appearance: textfield; appearance: textfield;" />
          </label>
        </div>
        <div class="control-box">
          <div class="pill">Legend</div>
          <div class="small">Net = Gross âˆ’ strokes (play off low CH). NDB cap applies.</div>
          <div class="small">Pot = Buy-in Ã— Active Players. Dollar winnings = (Skins won / Total skins) Ã— Pot.</div>
        </div>
      </div>
      <div class="banker-wrap">
        <table class="skins-table" id="skinsTable">
          <thead>
            <tr>
              <th>Name</th>
              <th>Holes Skinned</th>
              <th>Total</th>
              <th>Winnings</th>
            </tr>
          </thead>
          <tbody id="skinsBody"></tbody>
        </table>
      </div>
      <p class="small" id="skinsSummary">
        <!-- Player hole summaries will render here -->
      </p>
    </section>
    <!-- VEGAS GAME -->
    <section class="game-section" id="vegasSection" aria-hidden="true">
      <h2>Vegas Game</h2>
      <div class="vegas-controls">
        <div class="team-box">
          <div class="team-pill">Assign teams (exactly two per team)</div>
          <div class="team-grid" id="vegasTeams"></div>
          <div class="warn" id="vegasTeamWarning" hidden>Pick exactly two players on Team A and two on Team B.</div>
        </div>
        <div class="opts-box">
          <div class="team-pill">Options</div>
          <label class="radio">
            <input type="checkbox" id="optUseNet" /> Use Net (NDB) </label>
          <br />
          <label class="radio">
            <input type="checkbox" id="optDoubleBirdie" checked /> Double on Birdie (winner) </label>
          <br />
          <label class="radio">
            <input type="checkbox" id="optTripleEagle" checked /> Triple on Eagle (winner) </label>
          <br />
          <label class="radio" title="Dollar value per Vegas point">
            $/point
            <input type="number" id="vegasPointValue" min="0" step="0.25" value="1" inputmode="decimal" autocomplete="off" class="ch-input" style="width:96px; margin-left:8px" />
          </label>
        </div>
      </div>
      <div class="vegas-wrap">
        <table class="vegas-table" id="vegasTable">
          <thead>
            <tr>
              <th>Hole</th>
              <th>Team A</th>
              <th>Team B</th>
              <th>Mult</th>
              <th>Pts (A)</th>
              <th>Pts (B)</th>
            </tr>
          </thead>
          <tbody id="vegasBody"></tbody>
          <tfoot>
            <tr>
              <td>
                <strong>Totals</strong>
              </td>
              <td id="vegasTotalA">â€”</td>
              <td id="vegasTotalB">â€”</td>
              <td></td>
              <td id="vegasPtsA">â€”</td>
              <td id="vegasPtsB">â€”</td>
            </tr>
            <tr>
              <td>
                <strong>Dollars</strong>
              </td>
              <td id="vegasDollarA">â€”</td>
              <td id="vegasDollarB">â€”</td>
              <td></td>
              <td></td>
            </tr>
            <tr id="vegasGameBreakdown" style="display:none;">
              <td>
                <strong>Games</strong>
              </td>
              <td colspan="5" id="vegasGameBreakdownData" style="font-size: 0.9em; padding: 8px;">â€”</td>
            </tr>
          </tfoot>
        </table>
      </div>
      <p class="small">Vegas number puts the lower individual score first by default (e.g., 4 &amp; 5 â†’ <strong>45</strong>). If a team makes a birdie+, the other teamâ€™s digits flip (hiâ€“lo) for that hole. Points = (higher âˆ’ lower) Ã— multiplier; winner gets the points. </p>
    </section>
    <!-- BANKER GAME (stubbed: empty window) -->
    <section class="game-section" id="bankerSection" aria-hidden="true">
      <h2>Banker - To Be Added</h2>
    </section>
    <!-- BANKER-VEGAS GAME (placeholder) -->
    <section class="game-section" id="bankerVegasSection" aria-hidden="true">
      <h2>Banker-Vegas - To Be Added</h2>
    </section>
    <!-- HI-LO GAME (placeholder) -->
    <section class="game-section" id="hiloSection" aria-hidden="true">
      <h2>Hi-Lo</h2>
      <p class="note">Requires 4 players. Teams: Low+High handicap vs Middle two. 3 games: Front 9 (1 unit), Back 9 (1 unit), Full 18 (2 units).</p>
      
      <div class="vegas-controls">
        <div class="team-box">
          <div class="pill">Teams</div>
          <p id="hiloTeamA" style="margin: 4px 0;">Team A: â€”</p>
          <p id="hiloTeamB" style="margin: 4px 0;">Team B: â€”</p>
        </div>
      </div>

      <div class="vegas-wrap">
        <table class="vegas-table" id="hiloTable">
          <thead>
            <tr>
              <th>Game</th>
              <th>Team A</th>
              <th>Team B</th>
              <th>Winner</th>
            </tr>
          </thead>
          <tbody id="hiloResultsBody">
            <!-- Filled by JS -->
          </tbody>
        </table>
      </div>

      <h3 style="margin-top: 20px;">Hole-by-Hole Results</h3>
      <div class="vegas-wrap">
        <table class="vegas-table" id="hiloHoleTable">
          <thead>
            <tr>
              <th>Hole</th>
              <th>Low Score</th>
              <th>High Score</th>
              <th>Points</th>
            </tr>
          </thead>
          <tbody id="hiloHoleBody">
            <!-- Filled by JS -->
          </tbody>
        </table>
      </div>
    </section>
    <p class="note"> Net Double Bogey per hole: cap = Par + 2 + strokes received on that hole. Players "play off" the lowest CH (e.g., +2 / 2 / 4 â†’ adjusted 0 / 4 / 6). </p>
    <script src="index.js" defer></script>
    <script src="js/export.js" defer></script>
    <script src="js/vegas.js" defer></script>
    <script src="js/banker.js" defer></script>
    <script src="js/banker-vegas.js" defer></script>
    <script src="js/hilo.js" defer></script>
    <script src="js/skins.js" defer></script>
    <script src="js/junk.js" defer></script>
    <!-- Inline bootstrap to verify scripts run -->
    <script>
      console.log('[golfGames] inline bootstrap script loaded');
      
      // Highlight holes where players receive strokes
      window.addEventListener('DOMContentLoaded', function() {
        
        function updateStrokeHighlights() {
          // Use global HCPMEN (updated when course changes)
          const HCPMEN = window.HCPMEN;
          if (!HCPMEN || !Array.isArray(HCPMEN)) {
            console.error('[Highlights] HCPMEN not loaded - course data missing!');
            return; // Don't highlight if no course data
          }
          setTimeout(function() {
            const playerRows = document.querySelectorAll('.player-row');
            if(!playerRows.length) return;
            
            // Get all CHs
            const chs = [];
            playerRows.forEach(function(row) {
              const chInput = row.querySelector('.ch-input');
              const val = chInput && chInput.value !== '' ? parseFloat(chInput.value) : null;
              chs.push(val !== null && !isNaN(val) ? val : null);
            });
            
            // Calculate adjusted CHs (play off low) - only consider players with entered CHs
            const validCHs = chs.filter(function(ch) { return ch !== null; });
            if(validCHs.length === 0) return;
            
            const minCH = Math.min.apply(null, validCHs);
            const adjustedCHs = chs.map(function(ch) { return ch !== null ? ch - minCH : 0; });
            
            // Update each player's score inputs
            playerRows.forEach(function(row, playerIdx) {
              const adjustedCH = adjustedCHs[playerIdx];
              const scoreInputs = row.querySelectorAll('.score-input');
              
              // Only highlight if this player has a CH entered
              if(chs[playerIdx] === null) {
                scoreInputs.forEach(function(input) {
                  input.classList.remove('receives-stroke');
                  input.removeAttribute('title');
                });
                return;
              }
              
              scoreInputs.forEach(function(input, holeIdx) {
                const holeHCP = HCPMEN[holeIdx];
                // Correct formula: player gets stroke if their adjusted CH >= hole's HCP index
                const fullStrokes = Math.floor(adjustedCH / 18);
                const remainingStrokes = adjustedCH % 18;
                const getsStroke = remainingStrokes >= holeHCP;
                const totalStrokes = fullStrokes + (getsStroke ? 1 : 0);
                
                if(totalStrokes > 0) {
                  input.classList.add('receives-stroke');
                  input.setAttribute('data-strokes', totalStrokes);
                  input.setAttribute('title', 'Receives ' + totalStrokes + ' stroke(s)');
                } else {
                  input.classList.remove('receives-stroke');
                  input.removeAttribute('data-strokes');
                  input.removeAttribute('title');
                }
              });
            });
          }, 100);
        }
        
        // Update on CH input changes and score input changes
        document.addEventListener('input', function(e) {
          if(e.target && e.target.classList && (e.target.classList.contains('ch-input') || e.target.classList.contains('score-input'))) {
            updateStrokeHighlights();
          }
        });
        
        // Also update on load event from main script
        setTimeout(updateStrokeHighlights, 500);
        setTimeout(updateStrokeHighlights, 1000);
        
        // Make globally accessible for course switching
        window.updateStrokeHighlights = updateStrokeHighlights;
        
        // Initial update
        updateStrokeHighlights();
      });
    </script>
    <!-- JUNK GAME -->
    <section class="game-section" id="junkSection" aria-hidden="true">
      <h2>Junk (Dots)</h2>
      <div class="banker-controls">
        <div class="control-box">
          <div class="pill">Scoring</div>
          <label class="radio">
            <input type="checkbox" id="junkUseNet" /> Use NET scores (apply handicaps)
          </label>
        </div>
      </div>
      <div class="banker-wrap">
        <table class="junk-table" id="junkTable">
          <thead>
            <tr>
              <th>Hole</th>
              <th id="junkP1">P1</th>
              <th id="junkP2">P2</th>
              <th id="junkP3">P3</th>
              <th id="junkP4">P4</th>
            </tr>
          </thead>
          <tbody id="junkBody"></tbody>
          <tfoot>
            <tr>
              <td>
                <strong>Totals</strong>
              </td>
              <td id="junkTotP1">â€”</td>
              <td id="junkTotP2">â€”</td>
              <td id="junkTotP3">â€”</td>
              <td id="junkTotP4">â€”</td>
            </tr>
            <tr>
              <td>
                <strong>Net Totals</strong>
              </td>
              <td id="junkNetP1">â€”</td>
              <td id="junkNetP2">â€”</td>
              <td id="junkNetP3">â€”</td>
              <td id="junkNetP4">â€”</td>
            </tr>
          </tfoot>
        </table>
      </div>
      <p class="small">Dots per hole: Eagle = 4, Birdie = 2, Par = 1, otherwise 0. Use NET scoring to apply handicap strokes.</p>
    </section>

    <!-- QR Code Share Module -->
    <script src="js/qrcode.js"></script>

    <!-- PWA Service Worker Registration -->
    <script>
      // FORCE HARD RELOAD on every PWA open (mimics tap refresh)
      window.addEventListener('pageshow', (event) => {
        // If page was restored from cache (iOS back-forward cache), force reload
        if (event.persisted) {
          console.log('[PWA] Page from cache, forcing hard reload...');
          window.location.reload();
        }
      });
      
      // Force hard reload on first load if not already done
      if (!sessionStorage.getItem('pwa_reloaded')) {
        console.log('[PWA] First load, forcing hard reload...');
        sessionStorage.setItem('pwa_reloaded', 'true');
        window.location.reload(true); // Hard reload
      }
      
      if ('serviceWorker' in navigator) {
        let refreshing = false;
        
        // Listen for messages from service worker
        navigator.serviceWorker.addEventListener('message', (event) => {
          if (event.data && event.data.type === 'RELOAD') {
            if (!refreshing) {
              refreshing = true;
              console.log('[PWA] Service worker requested reload');
              window.location.reload();
            }
          }
        });
        
        // AGGRESSIVE: Unregister all service workers first, then re-register fresh
        navigator.serviceWorker.getRegistrations().then((registrations) => {
          console.log('[PWA] Found', registrations.length, 'existing registrations');
          return Promise.all(registrations.map(r => r.unregister()));
        }).then(() => {
          console.log('[PWA] All old registrations cleared');
          // Now register fresh
          return navigator.serviceWorker.register('/sw.js', { 
            updateViaCache: 'none' // Don't cache the service worker file itself
          });
        }).then((registration) => {
          console.log('[PWA] Service Worker registered fresh');
          
          // Force immediate update check
          registration.update();
          
          // Check for updates when page becomes visible (iOS app switching)
          document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
              console.log('[PWA] Page visible, checking for updates...');
              registration.update();
            }
          });
          
          // Check for updates every 10 seconds while app is open (aggressive for testing)
          setInterval(() => {
            registration.update();
          }, 10000);
          
          // Check when page gains focus (iOS specific)
          window.addEventListener('focus', () => {
            console.log('[PWA] Window focused, checking for updates...');
            registration.update();
          });
        }).catch((error) => {
          console.log('[PWA] Service Worker registration failed:', error);
        });
        
        // Auto-reload when new version takes control
        navigator.serviceWorker.addEventListener('controllerchange', () => {
          if (!refreshing) {
            refreshing = true;
            console.log('[PWA] New controller detected, reloading...');
            window.location.reload();
          }
        });
      }
    </script>
  </body>
</html>